#!/usr/bin/env bash
set -e

# Pull in the upstream charts
for f in packages/*; do
	if [[ -z $CHART || $CHART == $(basename -- ${f}) ]]; then
		if [[ -f ${f}/package.yaml ]]; then
			url=$(yq r ${f}/package.yaml url)
			if [[ -n ${url} ]]; then
				# Prepare the upstream chart and move it into the ${f}/charts to serve as the base
				# to apply the patch on top of
				./scripts/prepare-upstream ${f}
				rm -rf ${f}/charts
				mv ${f}/charts-original ${f}/charts
			fi
		fi
		# Loop through packages again and copy dependencies over
		# If sub-charts existed as package.yaml they will now be vendored into parent
		./scripts/prepare-subcharts ${f}

		# Apply the patch and split the CRD package
		if [[ -f ${f}/package.yaml ]]; then
			for file in $(find ./${f} -type f -name "*.patch"); do
				basename=$(basename -- ${file})
				patch -E -p3 -d ${f}/charts < ${f}/$basename
			done
			split_crds=$(cat ${f}/package.yaml | yq r - generateCRDChart.enabled)
			if [[ "${split_crds}" == "true" ]]; then
				./scripts/prepare-crds ${f}
			fi
		fi
	fi
done